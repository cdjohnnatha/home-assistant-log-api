name: Sync Home Assistant Scripts

on:
  push:
    branches: [main]
    paths: ['home-assistant-scripts/**']
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-home-assistant:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git configuration
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Sync home-assistant-scripts to home-assistant-config
      run: |
        # Create home-assistant-config directory structure (if not exists)
        mkdir -p home-assistant-config/custom/
        
        # Backup existing files that are not in source (if any)
        if [ -d "home-assistant-config/custom/" ]; then
          echo "📁 Preserving existing structure..."
          mkdir -p .backup-temp/
          cp -r home-assistant-config/custom/ .backup-temp/ 2>/dev/null || true
        fi
        
        # Remove only directories that will be replaced
        rm -rf home-assistant-config/custom/statistics/
        rm -rf home-assistant-config/custom/templates/
        rm -rf home-assistant-config/custom/automations/
        rm -rf home-assistant-config/custom/scripts/
        rm -rf home-assistant-config/custom/integrations/
        
        # Copy new content from source
        cp -r home-assistant-scripts/* home-assistant-config/custom/
        
        # Restore any other files that were not in source directories
        if [ -d ".backup-temp/" ]; then
          # This would restore files in other directories not managed by sync
          echo "📁 Backup preserved in case manual restore needed"
          rm -rf .backup-temp/
        fi
        
        # Add all changes to git
        git add home-assistant-config/
        
        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "No changes to sync"
          exit 0
        fi
        
        # Commit changes to the same repository
        git commit -m "🔄 Sync Home Assistant configurations
        
        - Updated home-assistant-config/custom/ from home-assistant-scripts/
        - Source commit: ${{ github.sha }}
        - Triggered by: ${{ github.event_name }}
        "
        
        git push origin main

    - name: Create summary
      run: |
        echo "## 🔄 Home Assistant Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Successfully synced \`home-assistant-scripts/\` to Home Assistant repository" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target Directory:** \`home-assistant-config/custom/\`" >> $GITHUB_STEP_SUMMARY
        echo "**Source Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🏠 Home Assistant will automatically reload configurations on next restart or manual reload." >> $GITHUB_STEP_SUMMARY 